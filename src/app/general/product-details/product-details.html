@let product = productSignal.productState();
@let auth = authSignal.authState();

@if (product.loading) {
  <p>Cargando producto...</p>
} @else if (product.error) {
  <div class="alert error">{{ product.error }}</div>
} @else {
  @if(!product.data){
    <p class="muted">Sin datos del producto.</p>
  } @else {
    @let finalPrice = product.data.price - (product.data.price * product.data.discountPercentage / 100);
    <section class="product-details">
      <section class="card product-hero">
        <div class="product-hero__media">
          <div class="gallery-main">
            <img [src]="product.data.thumbnail || product.data.images?.[0] || 'https://picsum.photos/seed/fallback/600'" [alt]="product.data.title">
          </div>
          @if(product.data.images?.length){
            <div class="gallery-thumbs">
              @for (img of product.data.images; track $index) {
                <img [src]="img" [alt]="product.data.title" />
              }
            </div>
          }
        </div>

        <div class="product-hero__info">
          <p class="muted">{{ product.data.brand }} · {{ product.data.category }}</p>
          <h1>{{ product.data.title }}</h1>

          <div class="price-block">
            @if(product.data.discountPercentage > 0){
              <div class="muted original-price">${{ product.data.price }}</div>
              <div class="price-final">
                <strong>${{ finalPrice }}</strong>
                <span class="badge success">{{ product.data.discountPercentage }}% OFF</span>
              </div>
            }@else{
              <div class="price-final">
                <strong>${{ product.data.price }}</strong>
              </div>
            }
            <div class="muted">Stock: {{ product.data.stock }}</div>
          </div>

          <div class="shipping">
            {{
              finalPrice >= 150000
                ? 'Envio gratis en tu compra'
                : (product.data.weight > 3 ? 'Envio estimado $3500' : 'Envio estimado $1800')
            }}
          </div>

          @if(auth.logged && !isOwner()){
            <div class="actions">
              <button type="button" class="btn primary">Comprar ahora</button>
              <button type="button" class="btn ghost">Agregar al carrito</button>
            </div>
          }@else if(auth.logged && isOwner()){
            <div class="actions">
              <span class="badge muted">Es tu publicacion</span>
              <a class="btn ghost" [routerLink]="['/productUpdate', product.data.id]">Editar producto</a>
            </div>
          }@else{
            <p class="muted">Inicia sesion para comprar o agregar al carrito.</p>
          }
        </div>
      </section>

      <section class="card">
        <h3>Descripcion</h3>
        <p>{{ product.data.description }}</p>
      </section>

      <section class="card">
        <h3>Envio y garantia</h3>
        <div class="grid">
          <div>
            <p class="muted">Peso</p>
            <strong>{{ product.data.weight }} kg</strong>
          </div>
          <div>
            <p class="muted">Garantia</p>
            <strong>{{ product.data.warrantyInformation || 'No especificada' }}</strong>
          </div>
          <div>
            <p class="muted">Envio</p>
            <strong>{{ product.data.shippingInformation || 'Consultar' }}</strong>
          </div>
        </div>
      </section>

      <section class="card">
        <h3>Tienda</h3>
        @if(product.data.store?.length){
          <ul class="list">
            @for (store of product.data.store; track store.id) {
              <li>
                <strong>{{ store.address }}</strong>
                <div class="muted">{{ store.city }} - {{ store.country }}</div>
                <div class="muted">Tel: {{ store.phone }}</div>
              </li>
            }
          </ul>
        }@else{
          <p class="muted">Sin datos de tienda.</p>
        }
      </section>

      <section class="card">
        <h3>Resenas</h3>
        @if(auth.logged && !hasReview()){
          <form class="grid" novalidate>
            <div class="stars">
              @for (star of stars; track star) {
                <button type="button" class="star" [class.filled]="star <= selectedRating" (click)="setRating(star)">★</button>
              }
              <span class="muted">{{ selectedRating }} / 5</span>
            </div>
            <label>Comentario<textarea #comment rows="3" placeholder="Escribe tu experiencia"></textarea></label>
            <div class="form-actions">
              <button type="button" class="btn primary" (click)="submitReview(selectedRating, comment.value)">Enviar resena</button>
            </div>
          </form>
        }@else if(auth.logged && hasReview()){
          <p class="muted">Ya dejaste una resena.</p>
          <button type="button" class="btn ghost" (click)="deleteReview()">Eliminar mi resena</button>
        }@else{
          <p class="muted">Inicia sesion para dejar una resena.</p>
        }

        @if(product.data.reviews?.length){
          <ul class="list">
            @for (review of product.data.reviews; track review.username) {
              <li>
                <strong>{{ review.username }}</strong>
                <p>{{ review.comment || 'Sin comentario' }}</p>
                <div class="review-rating">
                  @for (star of stars; track star) {
                    <span class="star" [class.filled]="review.rating >= star">★</span>
                  }
                </div>
              </li>
            }
          </ul>
        }@else{
          <p class="muted">Sin resenas aun.</p>
        }
      </section>
    </section>
  }
}
