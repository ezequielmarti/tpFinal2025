@let product = productState();
@let auth = authState();

@if (product.loading) {
  <p>Cargando producto...</p>
} @else if (product.error) {
  <div class="alert error" role="alert">{{ product.error }}</div>
} @else {
  @if (!product.data) {
    <p class="muted">Sin datos del producto.</p>
  } @else {
    <section class="product-details">
      <section class="card product-hero">
        <div class="product-hero__media">
          <div class="gallery-main">
            <img
              [ngSrc]="product.data.thumbnail || product.data.images?.[0] || fallbackImage"
              [alt]="product.data.title"
              width="720"
              height="480"
              priority
            />
          </div>
          @if (product.data.images?.length) {
            <div class="gallery-thumbs">
              @for (img of product.data.images; track $index) {
                <img
                  [ngSrc]="img"
                  [alt]="product.data.title"
                  width="160"
                  height="120"
                  loading="lazy"
                />
              }
            </div>
          }
        </div>

        <div class="product-hero__info">
          <p class="muted">{{ product.data.brand }} Â· {{ product.data.category }}</p>
          <h1>{{ product.data.title }}</h1>

          <div class="price-block">
            @if (product.data.discountPercentage > 0 && finalPrice() !== null) {
              <div class="muted original-price">${{ product.data.price }}</div>
              <div class="price-final">
                <strong>${{ finalPrice() }}</strong>
                <span class="badge success">{{ product.data.discountPercentage }}% OFF</span>
              </div>
            } @else {
              <div class="price-final">
                <strong>${{ product.data.price }}</strong>
              </div>
            }
            <div class="muted">Stock: {{ product.data.stock }}</div>
          </div>

          <div class="shipping">{{ shippingMessage() }}</div>

          @if (auth.logged && isOwner()) {
            <div class="actions">
              <span class="badge muted">Es tu publicacion</span>
              <a class="btn ghost" [routerLink]="['/productUpdate', product.data.id]">Editar producto</a>
            </div>
          } @else if (canBuy()) {
            <div class="actions">
              <button type="button" class="btn primary" (click)="buyNow()">Comprar ahora</button>
              <button type="button" class="btn ghost" (click)="addToCart()">Agregar al carrito</button>
            </div>
          } @else {
            <p class="muted">Inicia sesion para comprar o agregar al carrito.</p>
          }
        </div>
      </section>

      <section class="card">
        <h3>Descripcion</h3>
        <p>{{ product.data.description }}</p>
        @if (product.data.tags?.length) {
          <div class="tags" style="display:flex; align-items:center; gap: 0.1em; flex-wrap:wrap;">
            <span class="muted">Tags:</span>
            <div class="tag-list" style="display:flex; flex-wrap:wrap; gap:0.1rem;">
              @for (tag of product.data.tags; track tag) {
                <span class="tag badge muted" style="padding:0.25rem 0.5rem; border-radius:999px;">{{ tag }}  |</span>
              }
            </div>
          </div>
        }
      </section>

      <!--
      <section class="card">
        <h3>Resenas</h3>
        @if (auth.logged && canReview()) {
          <form class="grid" [formGroup]="reviewForm" (ngSubmit)="submitReview()" novalidate>
            <div class="stars">
              @for (star of stars; track star) {
                <button type="button" class="star" [class.filled]="star <= selectedRating()" (click)="setRating(star)">&#9733;</button>
              }
              <span class="muted">{{ selectedRating() }} / 5</span>
            </div>
            <label>
              <span>Comentario</span>
              <textarea rows="3" formControlName="comment" placeholder="Escribe tu experiencia"></textarea>
            </label>
            <div class="form-actions">
              <button type="submit" class="btn primary">Enviar resena</button>
            </div>
          </form>
        } @else if (auth.logged && hasReview()) {
          <p class="muted">Ya dejaste una resena.</p>
          <button type="button" class="btn ghost" (click)="deleteReview()">Eliminar mi resena</button>
        } @else {
          <p class="muted">Inicia sesion para dejar una resena.</p>
        }

        @if (product.data.reviews?.length) {
          <ul class="list">
            @for (review of product.data.reviews; track review.username) {
              <li>
                <strong>{{ review.username }}</strong>
                <p>{{ review.comment || 'Sin comentario' }}</p>
                <div class="review-rating">
                  @for (star of stars; track star) {
                    <span class="star" [class.filled]="review.rating >= star">&#9733;</span>
                  }
                </div>
              </li>
            }
          </ul>
        } @else {
          <p class="muted">Sin resenas aun.</p>
        }
      </section>
      -->
    </section>
  }
}
