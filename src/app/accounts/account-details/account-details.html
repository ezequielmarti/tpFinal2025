@let account = accountState();
@let auth = authState();

<section class="account-details">
  @if(!auth.role){
    <p>Cargando perfil...</p>
  }@else if(account.loading){
    <p>Cargando datos de tu cuenta...</p>
  }@else if (account.error){
    <div class="alert error">Error: {{ account.error }}</div>
  }@else if (!account.data) {
    <div class="alert error">No pudimos obtener los datos de tu cuenta.</div>
  }@else {
    <header class="page-header">
      <div>
        <h2>Mi cuenta</h2>
        <p class="muted">Datos de perfil, direcciones y locales</p>
      </div>
      <div class="actions">
        @if(!edit()){
          <button type="button" class="btn" (click)="onEditToggle(true)">Editar</button>
        }@else{
          <button type="button" class="btn ghost" (click)="onEditToggle(false)">Cancelar</button>
        }
      </div>
    </header>

    <section class="card summary">
      <div>
        <p class="muted">Usuario</p>
        <h3>{{ account.data.username }}</h3>
      </div>
      <div>
        <p class="muted">Email</p>
        <h3>{{ account.data.email }}</h3>
      </div>
      <div>
        <p class="muted">Rol</p>
        <span class="badge muted">{{ auth.role }}</span>
      </div>
    </section>

    @switch(getRoleGroup(auth.role!)){
      @case ('user') {
        @if(!edit()){
          <div class="details-grid">
            <section class="card stretch">
              <h3>Datos personales</h3>
              <dl class="meta two-cols">
                <div><dt>Nombre</dt><dd>{{ account.data.userProfile?.firstname }} {{ account.data.userProfile?.lastname }}</dd></div>
                <div><dt>Usuario</dt><dd>{{ account.data.username }}</dd></div>
                <div><dt>Email</dt><dd>{{ account.data.email }}</dd></div>
                <div><dt>Telefono</dt><dd>{{ account.data.userProfile?.phone || '-' }}</dd></div>
                <div><dt>Fecha nac.</dt><dd>{{ account.data.userProfile?.birth || '-' }}</dd></div>
              </dl>
            </section>

            <section class="card stretch">
              <h3>Direcciones</h3>
              @if(account.data.address?.length){
                <ul class="list padded">
                  @for (addr of account.data.address; track addr.id) {
                    <li>
                      <strong>{{ addr.address }}</strong>
                      <div class="muted">{{ addr.city }} ({{ addr.zip }}) - {{ addr.country }}</div>
                      <div class="muted">Depto: {{ addr.apartment || '-' }}</div>
                    </li>
                  }
                </ul>
              }@else{
                <p class="muted">Aun no agregaste direcciones.</p>
              }
            </section>
          </div>
        }@else {
          <section class="card">
            <h3>Editar perfil</h3>
            <p class="muted">Completa los datos y guarda para actualizar.</p>
            <form class="inline" [formGroup]="userForm" (ngSubmit)="saveUser()">
              <label>Nombre<input formControlName="firstname" placeholder="Nombre" /></label>
              <label>Apellido<input formControlName="lastname" placeholder="Apellido" /></label>
              <label>Telefono<input formControlName="phone" placeholder="Sin telefono" /></label>
              <label>Fecha nac.<input type="date" formControlName="birth" /></label>
              <div class="form-actions">
                <button type="submit" class="btn" [disabled]="userForm.invalid || !userForm.dirty">Guardar</button>
                <button type="button" class="btn ghost" (click)="onEditToggle(false)">Cancelar</button>
              </div>
            </form>
            @if(auth.role === Role.User){
              <div class="seller-upgrade card muted">
                <h4>Quiero vender</h4>
                <p class="muted">Tu cuenta pasara a seller y no podras volver a solo comprador.</p>
                <div class="form-actions">
                  <button type="button" class="btn" (click)="requestSeller()">Solicitar cambio a seller</button>
                </div>
              </div>
            }@else{
              <p class="muted">Tu cuenta ya es seller</p>
            }
          </section>
        }
      }
      @case ('business') {
        @if(!edit()){
          <div class="details-grid">
            <section class="card stretch">
              <h3>Perfil de negocio</h3>
              <dl class="meta two-cols">
                <div><dt>Nombre publico</dt><dd>{{ account.data.businessProfile?.title }}</dd></div>
                <div><dt>Bio</dt><dd>{{ account.data.businessProfile?.bio || '-' }}</dd></div>
                <div><dt>Contacto</dt><dd>{{ account.data.businessProfile?.contactEmail }}</dd></div>
                <div><dt>Telefono</dt><dd>{{ account.data.businessProfile?.phone }}</dd></div>
              </dl>
            </section>

            <section class="card stretch">
              <h3>Locales</h3>
              @if(account.data.store?.length){
                <ul class="list padded">
                  @for (store of account.data.store; track store.id) {
                    <li>
                      <strong>{{ store.address.address }}</strong>
                      <div class="muted">{{ store.address.city }} - {{ store.address.country }}</div>
                      <div class="muted">Tel: {{ store.phone }}</div>
                    </li>
                  }
                </ul>
              }@else{
                <p class="muted">Sin locales cargados.</p>
              }
            </section>
          </div>
        }@else{
          <section class="card">
            <h3>Editar negocio</h3>
            <form [formGroup]="businessForm" (ngSubmit)="saveBusiness()">
              <div class="inline">
                <label>Nombre publico<input formControlName="title" placeholder="Nombre público" /></label>
                <label>Correo de contacto<input type="email" formControlName="contactEmail" placeholder="contacto@tienda.com" /></label>
              </div>
              <label>Bio<textarea rows="3" formControlName="bio" placeholder="Sin bio"></textarea></label>
              <div class="inline">
                <label>Telefono<input formControlName="phone" placeholder="Teléfono" /></label>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn" [disabled]="businessForm.invalid || !businessForm.dirty">Guardar</button>
                <button type="button" class="btn ghost" (click)="onEditToggle(false)">Cancelar</button>
              </div>
            </form>
          </section>
        }
      }
      @case ('admin') {
        @if(!edit()){
          <section class="card stretch">
            <h3>Perfil administrador</h3>
            <dl class="meta two-cols">
              <div><dt>Nombre publico</dt><dd>{{ account.data.adminProfile?.publicName }}</dd></div>
              <div><dt>Usuario</dt><dd>{{ account.data.username }}</dd></div>
              <div><dt>Email</dt><dd>{{ account.data.email }}</dd></div>
            </dl>
          </section>
        }@else{
          <section class="card">
            <h3>Editar perfil admin</h3>
            <form [formGroup]="adminForm" (ngSubmit)="saveAdmin()">
              <div class="inline">
                <label>Nombre publico<input formControlName="publicName" placeholder="Nombre público" /></label>
                <label>Email<input formControlName="email" placeholder="Email" /></label>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn" [disabled]="adminForm.invalid || !adminForm.dirty">Guardar</button>
                <button type="button" class="btn ghost" (click)="onEditToggle(false)">Cancelar</button>
              </div>
            </form>
          </section>
        }
      }
    }
  }
</section>
