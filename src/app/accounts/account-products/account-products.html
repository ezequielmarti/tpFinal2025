@let products = productSignal.accountProductsState();

<section class="account-products">
  @if (noAccess()) {
    <div class="card warning">
      <h2>No podes publicar</h2>
      <p>Este modulo es solo para cuentas seller.</p>
      <a [routerLink]="['/accountDetails']" class="btn primary">Ver mi perfil</a>
    </div>
  } @else {
    <header class="toolbar">
      <div>
        <h2>Mis productos</h2>
        <p class="muted">Gestiona precio, stock y descuentos.</p>
      </div>
      <div class="actions">
        <button type="button" class="btn ghost" (click)="productSignal.getProductList()">Actualizar lista</button>
        <button type="button" class="btn primary" (click)="onGenerate()" [disabled]="generate()">Agregar producto</button>
      </div>
    </header>

    @if (products.loading) {
      <p>Cargando productos...</p>
    } @else if (products.error) {
      <div class="card error">
        <p>{{ products.error }}</p>
        <button type="button" class="btn" (click)="productSignal.getProductList()">Reintentar</button>
      </div>
    } @else if (generate()) {
      <section class="card">
        <h3>Nuevo producto</h3>
        <form class="grid" (ngSubmit)="onSubmit()">
          <label>Titulo<input name="title" required /></label>
          <label>Descripcion<textarea name="description" rows="3" required></textarea></label>
          <label>Categoria<input name="category" required /></label>
          <div class="inline">
            <label>Precio<input name="price" type="number" step="0.01" required /></label>
            <label>Stock inicial<input name="stock" type="number" required /></label>
            <label>Descuento %<input name="discount" type="number" min="0" max="100" step="1" /></label>
          </div>
          <div class="inline">
            <label>Marca<input name="brand" /></label>
            <label>Tags<input name="tags" placeholder="separados por coma" /></label>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn primary">Guardar</button>
            <button type="button" class="btn ghost" (click)="onCancel()">Cancelar</button>
          </div>
        </form>
      </section>
    } @else {
      @if (!products.data?.length) {
        <div class="card">
          <p>Todavia no publicaste productos.</p>
          <button type="button" class="btn primary" (click)="onGenerate()">Crear mi primer producto</button>
        </div>
      } @else {
        <div class="product-grid owner-grid">
          @for (product of products.data; track product.id) {
            <article class="card owner-card">
              <img class="owner-card__media" [src]="product.thumbnail || 'https://picsum.photos/seed/fallback/200/200'" [alt]="product.title">

              <div class="owner-card__title">
                <div>
                  <h3>{{ product.title }}</h3>
                  <p class="muted">{{ product.description }}</p>
                </div>
                <div class="actions column-actions">
                  <span class="badge muted">ID: {{ product.id }}</span>
                </div>
              </div>

              <div class="owner-card__price">
                @if(product.discountPercentage > 0){
                  <div class="price-original">${{ product.price }}</div>
                  <div class="price-final">${{ product.price - (product.price * product.discountPercentage / 100) }}</div>
                  <span class="badge success">{{ product.discountPercentage }}% OFF</span>
                }@else{
                  <div class="price-final">${{ product.price }}</div>
                }
              </div>

              <div class="owner-card__stats">
                <div><strong>Categoria:</strong> {{ product.category }}</div>
                <div><strong>Marca:</strong> {{ product.brand }}</div>
                <div><strong>Stock:</strong> {{ product.stock }}</div>
                <div><strong>Descuento:</strong> {{ product.discountPercentage }}%</div>
              </div>

              <div class="owner-card__updates">
                <div class="update-row">
                  <div class="update-label">Nuevo precio</div>
                  <div class="update-field">
                    <input #newPrice type="number" step="0.01" [value]="product.price" />
                    <button type="button" class="btn ghost"
                            (click)="productSignal.updatePrice(product.id, newPrice.valueAsNumber || 0)"
                            [disabled]="products.updateLoading">Guardar</button>
                  </div>
                </div>
                <div class="update-row">
                  <div class="update-label">Stock (+/-)</div>
                  <div class="update-field">
                    <input #stockDelta type="number" step="1" value="0" />
                    <button type="button" class="btn ghost"
                            (click)="productSignal.updateStock(product.id, stockDelta.valueAsNumber || 0)"
                            [disabled]="products.updateLoading">Guardar</button>
                  </div>
                </div>
                <div class="update-row">
                  <div class="update-label">Descuento %</div>
                  <div class="update-field">
                    <input #newDiscount type="number" min="0" max="100" step="1"
                           [value]="product.discountPercentage" />
                    <button type="button" class="btn ghost"
                            (click)="productSignal.updateDiscount(product.id, newDiscount.valueAsNumber || 0)"
                            [disabled]="products.updateLoading">Guardar</button>
                  </div>
                </div>
              </div>

              <footer class="muted owner-card__footer">
                <span>Tags: {{ product.tags?.join(', ') || 'Sin tags' }}</span>
                <button type="button" class="btn ghost" (click)="onEdit(product.id)">Editar</button>
              </footer>
            </article>
          }
        </div>
        @if (products.updateError) {
          <p class="error">Hubo un problema: {{ products.updateError }}</p>
        }
      }
    }
  }
</section>
