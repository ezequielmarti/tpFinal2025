@let products = productSignal.accountProductsState();

<section class="account-products">
  @if (noAccess()) {
    <div class="card warning">
      <h2>No podes publicar</h2>
      <p>Este modulo es solo para cuentas seller.</p>
      <a [routerLink]="['/accountDetails']" class="btn primary">Ver mi perfil</a>
    </div>
  } @else {
    <header class="toolbar">
      <div>
        <h2>Mis productos</h2>
        <p class="muted">Gestiona precio, stock y descuentos.</p>
      </div>
      <div class="actions">
        <button type="button" class="btn ghost" (click)="productSignal.getProductList()">Actualizar lista</button>
        <button type="button" class="btn primary" (click)="onGenerate()" [disabled]="generate()">Agregar producto</button>
      </div>
    </header>

    @if (products.loading) {
      <p>Cargando productos...</p>
    } @else if (products.error) {
      <div class="card error">
        <p>{{ products.error }}</p>
        <button type="button" class="btn" (click)="productSignal.getProductList()">Reintentar</button>
      </div>
    } @else if (generate()) {
      <section class="card">
        <h3>Nuevo producto</h3>
        <form class="grid" [formGroup]="createForm" (ngSubmit)="onSubmit()" novalidate>
          <div class="inline" style="gap:1.75rem; flex-wrap:wrap; align-items:flex-start; margin-bottom:1.25rem;">
            <label style="flex:1 1 280px; min-width:240px; max-width:505px; gap:0.35rem; display:flex; flex-direction:column;">Titulo<input formControlName="title" required /></label>
            <label style="flex:1 1 280px; min-width:240px; max-width:505px; gap:0.35rem; display:flex; flex-direction:column;">Categoria
              <select formControlName="category" required style="min-height:38px;">
                <option value="" disabled selected hidden>Selecciona una categoria</option>
                @for (cat of categories; track cat) {
                  <option [value]="cat">{{ cat }}</option>
                }
              </select>
            </label>
          </div>
          <label style="width:100%; max-width:1020px; margin-bottom:1.2rem; display:flex; flex-direction:column; gap:0.35rem;">Descripcion<textarea formControlName="description" rows="3" required></textarea></label>
          <div class="inline" style="gap:1.6rem; flex-wrap:wrap; align-items:flex-start; margin-bottom:1.3rem;">
            <label style="flex:1 1 220px; min-width:180px; max-width:237px; display:flex; flex-direction:column; gap:0.35rem;">Precio<input formControlName="price" type="number" step="0.01" required /></label>
            <label style="flex:1 1 220px; min-width:180px; max-width:237px; display:flex; flex-direction:column; gap:0.35rem;">Stock inicial<input formControlName="stock" type="number" required /></label>
            <label style="flex:1 1 220px; min-width:180px; max-width:237px; display:flex; flex-direction:column; gap:0.35rem;">Descuento %<input formControlName="discount" type="number" min="0" max="100" step="1" /></label>
            <label style="flex:1 1 200px; min-width:170px; max-width:237px; display:flex; flex-direction:column; gap:0.35rem;">Marca<input formControlName="brand" /></label>
          </div>
          <div class="inline">
            <div class="tags-field">
              <span>Tags</span>
              <div class="tags-grid" style="display:grid; grid-template-columns: repeat(13, minmax(0, 1fr)); gap:0.5rem 0.75rem; align-items:start;">
                @for (tag of tags; track tag) {
                  <label class="tag-option" style="display:flex; align-items:center; gap:0.35rem; font-size:0.9rem;">
                    <input type="checkbox"
                           [checked]="createForm.controls.tags.value.includes(tag)"
                           (change)="onTagToggle(tag, $event.target.checked)" />
                    <span>{{ tag }}</span>
                  </label>
                }
              </div>
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn primary" [disabled]="createForm.invalid || products.updateLoading">Guardar</button>
            <button type="button" class="btn ghost" (click)="onCancel()">Cancelar</button>
          </div>
          @if (products.updateError) {
            <p class="error">{{ products.updateError }}</p>
          }
        </form>
      </section>
    } @else {
      @if (!products.data?.length) {
        <div class="card">
          <p>Todavia no publicaste productos.</p>
          <button type="button" class="btn primary" (click)="onGenerate()">Crear mi primer producto</button>
        </div>
      } @else {
        <div class="product-grid owner-grid">
          @for (product of products.data; track product.id) {
            <article class="card owner-card">
              <img class="owner-card__media" [src]="product.thumbnail || 'https://picsum.photos/seed/fallback/200/200'" [alt]="product.title">

              <div class="owner-card__title">
                <div>
                  <h3>{{ product.title }}</h3>
                  <p class="muted">{{ product.description }}</p>
                </div>
                <div class="actions column-actions">
                  <span class="badge muted">ID: {{ product.id }}</span>
                </div>
              </div>

              <div class="owner-card__price">
                @if(product.discountPercentage > 0){
                  <div class="price-original">${{ product.price }}</div>
                  <div class="price-final">${{ product.price - (product.price * product.discountPercentage / 100) }}</div>
                  <span class="badge success">{{ product.discountPercentage }}% OFF</span>
                }@else{
                  <div class="price-final">${{ product.price }}</div>
                }
              </div>

              <div class="owner-card__stats">
                <div><strong>Categoria:</strong> {{ product.category }}</div>
                <div><strong>Marca:</strong> {{ product.brand }}</div>
                <div><strong>Stock:</strong> {{ product.stock }}</div>
                <div><strong>Descuento:</strong> {{ product.discountPercentage }}%</div>
              </div>

              <div class="owner-card__updates">
                <div class="update-row">
                  <div class="update-label">Nuevo precio</div>
                  <div class="update-field">
                    <input #newPrice type="number" step="0.01" [value]="product.price" />
                    <button type="button" class="btn ghost"
                            (click)="productSignal.updatePrice(product.id, newPrice.valueAsNumber || 0)"
                            [disabled]="products.updateLoading">Guardar</button>
                  </div>
                </div>
                <div class="update-row">
                  <div class="update-label">Stock (+/-)</div>
                  <div class="update-field">
                    <input #stockDelta type="number" step="1" value="0" />
                    <button type="button" class="btn ghost"
                            (click)="productSignal.updateStock(product.id, stockDelta.valueAsNumber || 0)"
                            [disabled]="products.updateLoading">Guardar</button>
                  </div>
                </div>
                <div class="update-row">
                  <div class="update-label">Descuento %</div>
                  <div class="update-field">
                    <input #newDiscount type="number" min="0" max="100" step="1"
                           [value]="product.discountPercentage" />
                    <button type="button" class="btn ghost"
                            (click)="productSignal.updateDiscount(product.id, newDiscount.valueAsNumber || 0)"
                            [disabled]="products.updateLoading">Guardar</button>
                  </div>
                </div>
              </div>

              <footer class="muted owner-card__footer">
                <span>Tags: {{ product.tags?.join(', ') || 'Sin tags' }}</span>
                <div class="actions">
                  <button type="button" class="btn ghost" (click)="onEdit(product.id)">Editar</button>
                  <button type="button" class="btn danger" (click)="productSignal.deleteProduct(product.id)" [disabled]="products.updateLoading">Eliminar</button>
                </div>
              </footer>
            </article>
          }
        </div>
        @if (products.updateError) {
          <p class="error">Hubo un problema: {{ products.updateError }}</p>
        }
      }
    }
  }
</section>
